pipeline {
    agent any

    options { skipDefaultCheckout(true) }

    stages {

        stage('Get Code') {
            steps {
                    checkout scm
                    script {
                        def configuredBranch = (scm?.branches?.getAt(0)?.name ?: '')
                            .replaceFirst('^\\*/', '')
                            .replaceFirst('^origin/', '')
                            .trim()

                        echo "configuredBranch: ${configuredBranch}"
                        env.PIPELINE_BRANCH = configuredBranch
                    }
                sh 'echo "################# USER=$(whoami) | HOST=$(hostname) | WORKSPACE=$WORKSPACE"'
                stash name: 'code', includes: '**'

                }
        }
        stage('CI') {
            when { expression { env.PIPELINE_BRANCH == 'develop' } }

            stages {

                stage('Static and Security Tests') {

                    parallel {
                        stage('Static') {

                            agent { label 'analysis' }

                            steps {

                                unstash name: 'code'

                                sh '''
                                    echo "################# USER=$(whoami) | HOST=$(hostname) | WORKSPACE=$WORKSPACE"
                                    python3 -m flake8 ./src --format=pylint > flake8.out
                                '''

                                archiveArtifacts artifacts: 'flake8.out', fingerprint: true
                                deleteDir()

                            }
                        } //Stage static

                        stage('Security') {

                            agent { label 'analysis' }

                            steps {

                                unstash name: 'code'

                                sh '''
                                    echo "################# USER=$(whoami) | HOST=$(hostname) | WORKSPACE=$WORKSPACE"

                                    python3 -m bandit -r ./src -f custom -o bandit.out --msg-template "{abspath}:{line}: [{test_id}] {msg}"
                                '''
                                archiveArtifacts artifacts: 'bandit.out', fingerprint: true
                                deleteDir()
                            }
                        }
                    }//parallel
                }//stage static and security

                stage('Deploy') {

                    steps {
                    
                        sh '''
                            echo "################# USER=$(whoami) | HOST=$(hostname) | WORKSPACE=$WORKSPACE"

                            export AWS_REGION=us-east-1
                            export AWS_DEFAULT_REGION=us-east-1

                            set -eux

                            sam build
                            sam validate

                            sam deploy --config-env staging --resolve-s3 --no-fail-on-empty-changeset
                        '''
                        script {
                            env.BASE_URL = sh(
                                script: '''
                                    aws cloudformation describe-stacks \
                                    --stack-name todo-list-aws-staging \
                                    --region us-east-1 \
                                    --query "Stacks[0].Outputs[?OutputKey=='BaseUrlApi'].OutputValue" \
                                    --output text
                                ''',
                                returnStdout: true
                                ).trim();

                                echo "BASE_URL raw => '${env.BASE_URL}'"
                    
                            if (!env.BASE_URL) {
                                error("Base_URL vacio.")
                            }
                        }
                    }
                } //Stage Deploy

                stage('Rest Test') {
                    agent { label 'rest' }

                    steps {

                        unstash name: 'code'

                        sh '''
                            echo "################# USER=$(whoami) | HOST=$(hostname) | WORKSPACE=$WORKSPACE"

                            pytest -s --junitxml=result-rest.xml test/integration/todoApiTest.py
                        '''
                        
                        junit 'result-rest.xml'
                        deleteDir()
                    }
                }

                stage('Promote') {

                    steps {

                        unstash name: 'code'

                        withCredentials([usernamePassword(credentialsId: 'CP14',
                                  usernameVariable: 'GIT_USER',
                                  passwordVariable: 'GIT_TOKEN')]) {
                            sh '''
                                echo "################# USER=$(whoami) | HOST=$(hostname) | WORKSPACE=$WORKSPACE"

                                set -eux
                                git config user.name "${GIT_USER}"
                                git config user.email "jenkins-ci@local"

                                git remote set-url origin https://${GIT_TOKEN}@github.com/JesusCanor/todo-list-aws.git

                                git fetch origin
                                
                                git checkout -B master origin/master
                                git merge --no-ff -X theirs origin/develop -m "Promote develop to Master"


                                git push origin master
                            '''
                            deleteDir()
                        }
                    }
                }
            }//stages CI
        }//CI

        stage('CD') {
            when { expression { env.PIPELINE_BRANCH == 'master' } }

            stages {

                stage('Deploy') {

                    steps {

                        sh '''
                            echo "################# USER=$(whoami) | HOST=$(hostname) | WORKSPACE=$WORKSPACE"

                            set -eux
                            export AWS_DEFAULT_REGION=us-east-1

                            sam build
                            sam validate

                            sam deploy --config-env production --resolve-s3 --no-fail-on-empty-changeset
                        '''

                        script {
                            env.BASE_URL = sh(
                                script: '''
                                    aws cloudformation describe-stacks \
                                    --stack-name todo-list-aws-staging \
                                    --region us-east-1 \
                                    --query "Stacks[0].Outputs[?OutputKey=='BaseUrlApi'].OutputValue" \
                                    --output text
                                ''',
                                returnStdout: true
                                ).trim();

                                echo "BASE_URL raw => '${env.BASE_URL}'"
                    
                            if (!env.BASE_URL) {
                                error("Base_URL vacio.")
                            }
                        }
                    }
                } //Stage Deploy

                stage('Rest Test') {
                    agent { label 'rest' }
                    
                    steps {
                        unstash name: 'code'

                        script {
                            echo "BASE_URL raw => '${env.BASE_URL}'"

                            if (!env.BASE_URL || env.BASE_URL == 'None') {
                                error("BASE_URL vacio.")
                            }
                        }

                        sh '''
                            echo "################# USER=$(whoami) | HOST=$(hostname) | WORKSPACE=$WORKSPACE"

                            pytest -s --junitxml=result-prod-rest.xml -m "readonly" test/integration/todoApiTest.py
                        '''
                        junit 'result-prod-rest.xml'
                        deleteDir()
                    }
                }
            }
        }//stages CD
    }//Stages
}//pipeline
